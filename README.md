# Household App

スマホ入力＋PC集計ができる家計簿アプリ。
※ 本アプリは「PCをサーバーとして、スマホから家計入力する」個人利用向けアプリです。

## 概要

- スマホから支出を入力
- IndexedDBに一時保存
- PC上のFastAPIへ同期
- PostgreSQLに保存
- 期間指定で集計・カテゴリ別表示

## 主な機能

- 支出入力（スマホ）
  - 金額は整数のみ入力可能（小数点不可）
  - 入力値の検証機能（金額、日付、メモの文字数制限など）
- 未送信データのローカル保存（IndexedDB）
  - 日付範囲での効率的な検索（範囲クエリ対応）
- オフライン対応（PWA）
- 同期処理
- QRコードによるAPI URL・APIキー自動設定
- APIキー認証（セキュリティ対策）
- 期間指定集計
- カテゴリ別集計
- 明細一覧表示
- 明細削除（論理削除）

## 技術構成

- **Frontend**: React + Vite + TypeScript
- **PWA**: vite-plugin-pwa（オフライン対応）
- **Backend**: FastAPI
- **DB**: PostgreSQL
- **Container**: Docker / docker-compose

## 使い方

### 日常的な使い方

1. スマホでフロントエンドにアクセス（PWAとしてホーム画面に追加可能）
2. 「入力」タブで支出を入力（オフライン可）
3. 「同期する」ボタンを押してPCのAPIに送信
4. 「集計」タブで期間を指定して集計・明細を確認

## ドキュメント

### 基本ドキュメント

- **[セットアップガイド](docs/SETUP.md)**: 初回セットアップ手順、環境変数設定
- **[運用・保守ガイド](docs/OPERATIONS.md)**: コマンドリファレンス、バックアップ、デプロイメント
- **[アーキテクチャ](docs/architecture.md)**: システム設計、API仕様、データモデル

### 開発者向け

- **[サーバー開発ガイド](server/README.md)**: バックエンド開発ガイド、コード構造、デバッグ方法
- **[クライアント開発](client/README.md)**: フロントエンド開発ガイド

### リファレンス

- **[APIリファレンス](docs/API.md)**: APIエンドポイントの詳細仕様、リクエスト/レスポンス例
- **[データベーススキーマ](docs/DATABASE.md)**: データベース構造、テーブル定義、クエリ例

### トラブルシューティング

- **[トラブルシューティングガイド](docs/TROUBLESHOOTING.md)**: よくある問題と解決方法

### その他

- **[セキュリティポリシー](SECURITY.md)**: セキュリティに関する情報、既知の制限事項

## 注意点

### 使用方法
- PCとスマホは同一ネットワーク（テザリング可）で接続する必要があります
- 初回はAPIのURLとAPIキーを設定してください（QRコード推奨）
  - QRコードは `http://[PCのIP]:8000/sync/page` で表示できます
  - QRコードを読み取ると、自動的にAPI URLとAPIキーが設定されます
  - QRコードには `sync_url` パラメータが含まれており、そこからAPI URLとAPIキーを取得します
  - QRコードのURL形式: `https://household-app.vercel.app/sync-setup?sync_url={URL}`（`sync_url`には`http://[PCのIP]:8000/sync/url`が含まれる）
- 金額は整数のみ入力可能です（小数点は使用できません）
- 日付の入力範囲に制限はありませんが、無効な日付形式はエラーになります

### データ管理
- APIキー認証により、同一ネットワーク内でも不正アクセスを防止しています
- DBデータはローカル環境のため、定期的にバックアップを取ることを推奨します（`backup_db.ps1` を使用）
- IndexedDBは自動的にバージョン管理され、スキーマ変更時は自動的にアップグレードされます

### PWA機能
- PWAとしてホーム画面に追加すると、オフラインでも入力可能です
- 同期はオンライン時のみ実行可能です
- localStorageの使用が制限されている環境（プライベートモードなど）では、設定の保存に失敗する可能性があります
- サーバー側の環境変数設定（`docker-compose.yml`）:
  - `API_KEY`: APIキー（**本番環境では必須**、未設定時は警告が出てデフォルト値 `household-app-secret-key-2024` を使用）
  - `HOST_IP`: PCのIPアドレス（QRコード生成時に使用、推奨）
  - `CORS_ORIGINS`: CORS許可オリジン（カンマ区切り、**本番環境では推奨**）
  - `FRONTEND_URL`: フロントエンドのURL（QRコード生成時に使用、デフォルト: `https://household-app.vercel.app`）
  - `ALLOW_SUBNETS`: LAN制限を有効にする場合の許可サブネット（カンマ区切り、例: `192.168.0.0/24,172.16.0.0/12`）

## セキュリティ

- **APIキー認証**: すべてのAPIリクエストにAPIキーが必要です（`X-API-Key` ヘッダー）
  - **本番環境では環境変数 `API_KEY` の設定を強く推奨**（未設定時は警告ログが出力されます）
  - デフォルトのAPIキー: `household-app-secret-key-2024`（開発用）
  - 認証不要なパス: `/health`, `/docs`, `/openapi.json`, `/sync/page`, `/sync/qr.png`, `/sync/url`, `/app`で始まるパス, `/favicon.ico`
- **CORS設定**: 許可されたオリジンのみアクセス可能（環境変数 `CORS_ORIGINS` で設定、カンマ区切り）
  - **本番環境では環境変数の設定を推奨**
  - デフォルト値（未設定時）: `https://household-app.vercel.app`, `http://localhost:5173`, `http://127.0.0.1:5173`
- **LAN制限**: オプションで `/sync` 配下のエンドポイントにLAN制限を設定可能（環境変数 `ALLOW_SUBNETS` で設定）
  - 設定例: `ALLOW_SUBNETS=192.168.0.0/24,172.16.0.0/12`
  - 未設定の場合はLAN制限は無効

詳細は `docs/architecture.md` を参照してください。

## ライセンス・注意

- 本アプリは個人利用を想定しています
- APIキー認証により基本的なセキュリティ対策を実装していますが、HTTPS未対応です
- 外部公開や商用利用には追加対策（HTTPS、より強固な認証等）が必要です
